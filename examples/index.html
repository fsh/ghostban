<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>GhostBan Example</title>
</head>

<body>
  <div id="root"></div>
  <script src="./index.min.js"></script>

  <script>
    let GB = window.ghostban;
    const { GhostBan, Sgf, Ki, SGF_LETTERS, canMove, MoveProp, calcSHA, genMove, buildMoveNode, calcMatAndMarkup } = GB;
    let dom = document.getElementById('root');
    let sgf = new Sgf()
    const c = `(;AW[hh]AW[lh]AW[hi]AW[ji]AW[li]AW[lj]AB[kg]AB[lg]AB[mg]AB[mh]AB[mi]AB[mj]AB[kk]AB[lk]AB[mk]C[Black to play and catch the three stones.]SZ[19]GM[1]FF[4]CA[UTF-8]AP[CGoban:2]ST[2]RU[Japanese]KM[0.00]TM[]DT[1999-07-28]SY[Cgoban 1.9.2] (;B[ki] (;W[kh] (;B[jh];W[kj];B[jj];W[ki];B[ii]C[CHOICERIGHT]) (;B[kj];W[jh])) (;W[kj] (;B[kh];W[jj]) (;B[jj];W[kh];B[jh]))) (;B[jh];W[jj]) (;B[jj];W[jh]) (;B[ii];W[jj]))`
    sgf.parse(c);
    console.log(sgf.toSgf());
    let root = sgf.root;
    let currentNode = root;
    let turn = Ki.Black;

    let { mat, markup } = calcMatAndMarkup(root)
    let g = new GhostBan({ padding: 30, interactive: true, zoom: true, extend: 3 });
    g.init(dom);
    g.setMat(mat);
    g.setMarkup(markup);
    g.setTheme(GB.Flat);
    g.calcBoardVisibleArea(true);

    g.render();

    dom.onclick = () => {
      i = g.cursor[0]
      j = g.cursor[1]
      const value = SGF_LETTERS[i] + SGF_LETTERS[j];
      let turn = Ki.Black;
      if (canMove(mat, i, j, turn)) {
        g.setTurn(-turn)
        const token = turn === Ki.Black ? 'B' : 'W';
        if (turn !== 0) {
          const sha = calcSHA(currentNode, [
            MoveProp.from(`${token}[${value}]`),
          ]);
          const filtered = currentNode.children.filter(
            (n) => n.model.id === sha
          );
          console.log(currentNode.getPath())
          console.log(sha)
          let node;
          if (filtered.length > 0) {
            node = filtered[0];
          } else {
            node = buildMoveNode(`${token}[${value}]`, currentNode);
            currentNode.addChild(node);
          }
          currentNode = node
        }
      }

      let res = calcMatAndMarkup(currentNode)
      g.setMat(res.mat);
      g.setMarkup(res.markup);

      g.render();
      g.renderInteractive();

      let nextNode = genMove(currentNode, (path) => {
        alert('right', path);
      }, (path) => {
        alert('wrong', path);
      }, (path) => { alert('variant', path); });
      // console.log(nextNode);
      if (nextNode) {
        currentNode = nextNode;
        console.log('next', currentNode)
        console.log('next', currentNode.model.id)
        let res = GB.calcMatAndMarkup(currentNode);
        g.setMat(res.mat);
        g.setMarkup(res.markup);
        g.render();
        g.renderInteractive();
      }
    }
  </script>
</body>

</html>